<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Track Your Order</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="order-tracking/style.css">

</head>

<body>
    <!-- Header -->
    <header>
        <div class="header-container">
            <div class="logo">
                <img src="headphonezoo.webp" alt="HeadphoneZoo Logo" class="logo-img">
                <span>HeadphoneZoo</span>
            </div>
            <nav>
                <ul class="nav-links">
                    <li><a href="https://headphonezoo.com">Home</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <section id="order-tracking-section" class="order-tracking-wrapper">
            <div class="tracking-container">
                <h2 class="tracking-title">Track Your Order</h2>
                <p class="tracking-desc">Enter your Order ID and Billing Email to see your order details and shipping
                    updates.</p>

                <div class="tracking-form-box">
                    <form id="trackForm">
                        <p class="form-row">
                            <label for="orderid">Order ID</label>
                            <input id="orderid" name="orderid" type="text" placeholder="Check your order email."
                                required />
                        </p>
                        <p class="form-row">
                            <label for="order_email">Billing Email</label>
                            <input id="order_email" name="order_email" type="email"
                                placeholder="Email used during checkout." required />
                        </p>
                        <p class="form-row">
                            <button type="submit">Track Order</button>
                        </p>
                    </form>

                    <div id="result" aria-live="polite" style="margin-top:1rem;"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <div class="footer-bottom">
                <p>HeadphoneZoo &copy; 2025. All rights reserved.</p>
            </div>
        </div>
    </footer>







    <script>
        /* ---------- Auto-fallback order tracking (SG -> AU) ---------- */
        const ENDPOINTS = {
            sg: {
                label: 'sg-checkout.headphonezoo.com',
                url: 'https://sg-checkout.headphonezoo.com/wp-json/ot-public/v1/order',
                token: 'i8lsqOKlnXA3DOy4Pr3GX0HIC8oIUoWU' // <-- put SG token here
            },
            au: {
                label: 'au-checkout.headphonezoo.com',
                url: 'https://au-checkout.headphonezoo.com/wp-json/ot-public/v1/order',
                token: 'i8lsqOKlnXA3DOy4Pr3GX0HIC8oIUoWU' // <-- put AU token here
            }
        };

        function sanitizeOrderId(input) {
            return input.trim().replace(/[^\w-]/g, '');
        }

        function renderAddressBox(title, obj) {
            if (!obj) return '';
            const lines = [];
            if (obj.first_name || obj.last_name) lines.push(`${obj.first_name || ''} ${obj.last_name || ''}`.trim());
            if (obj.company) lines.push(obj.company);
            if (obj.address_1) lines.push(obj.address_1);
            if (obj.address_2) lines.push(obj.address_2);
            let cityLine = '';
            if (obj.city) cityLine += obj.city;
            if (obj.state) cityLine += (cityLine ? ', ' : '') + obj.state;
            if (obj.postcode) cityLine += (cityLine ? ' ' : '') + obj.postcode;
            if (cityLine) lines.push(cityLine);
            if (obj.country) lines.push(obj.country);
            if (obj.email) lines.push(`<span style="display:inline-block;margin-top:6px;"><a href="mailto:${obj.email}">${obj.email}</a></span>`);
            return `<div class="address-box"><h4>${title}</h4><div class="addr">${lines.join('<br/>')}</div></div>`;
        }

        async function postToEndpoint(endpointObj, orderid, order_email) {
            const payload = { order_id: orderid, email: order_email, token: endpointObj.token };
            const res = await fetch(endpointObj.url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
                credentials: 'omit'
            });
            return res;
        }

        async function tryEndpoints(orderid, order_email, selected) {
            const info = { tried: [], success: null, lastError: null };
            const list = (selected === 'sg') ? ['sg'] : (selected === 'au') ? ['au'] : ['sg', 'au'];
            for (const key of list) {
                const ep = ENDPOINTS[key];
                info.tried.push(ep.label);
                try {
                    const res = await postToEndpoint(ep, orderid, order_email);

                    if (res.status === 403) {
                        const body = await res.json().catch(() => ({}));
                        info.lastError = { endpoint: ep.label, status: 403, message: body.message || body.error || 'Access denied (403). Token or origin mismatch.' };
                        continue;
                    }
                    if (!res.ok) {
                        const txt = await res.text().catch(() => res.statusText);
                        info.lastError = { endpoint: ep.label, status: res.status, message: txt || res.statusText };
                        continue;
                    }

                    const data = await res.json().catch(() => null);
                    if (!data) {
                        info.lastError = { endpoint: ep.label, status: res.status, message: 'Invalid JSON response' };
                        continue;
                    }

                    // treat "not found" responses properly
                    if (data.found === false || (typeof data.found === 'undefined' && !data.order_id && !data.items)) {
                        info.lastError = { endpoint: ep.label, status: res.status, message: data.message || 'Order not found on this site' };
                        continue;
                    }

                    info.success = { endpoint: ep.label, endpointKey: key, data: data };
                    return info;

                } catch (err) {
                    console.error('Network/CORS error contacting', ep.url, err);
                    info.lastError = { endpoint: ep.label, status: 0, message: 'Network or CORS error (check console / server headers).' };
                    continue;
                }
            }
            return info;
        }

        /* DOM submit handler */
        document.getElementById('trackForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const rawOrder = document.getElementById('orderid').value || '';
            const orderid = sanitizeOrderId(rawOrder);
            const order_email = document.getElementById('order_email').value.trim();
            const resultDiv = document.getElementById('result');
            const select = document.getElementById('sourceSite');
            const selected = select ? select.value : 'auto';

            if (!orderid || !order_email) {
                resultDiv.innerHTML = '<div class="error">Please enter order id and billing email.</div>';
                return;
            }

            resultDiv.innerHTML = `<em>Searching (${selected === 'auto' ? 'SG → AU' : selected.toUpperCase()})…</em>`;

            const outcome = await tryEndpoints(orderid, order_email, selected);

            if (outcome.success) {
                const data = outcome.success.data;
                let html = `<div class="order-result">
              <h3>Order #${data.order_id || ''} — status: ${data.status || ''}</h3>
              <p>Total: ${data.totals ? data.totals.total : ''} — Purchase Date: ${formatDate(data.date_created)}</p>
              <div class="order-items">`;
                for (const it of data.items || []) {
                    html += `<div class="hz-order-item">
                  <div class="hz-item-thumb">${it.product_image ? `<img src="${it.product_image}" alt="${(it.name || '')}" />` : ''}</div>
                  <div class="hz-item-name-wrap">
                    <div class="hz-item-name">${it.name || ''}</div>
                    <div class="hz-item-meta">Quantity: ${it.quantity || ''} — Subtotal: ${it.subtotal || ''}</div>
                    ${it.meta ? `<div class="hz-item-meta-small">${it.meta}</div>` : ''}
                  </div>
                </div>`;
                }
                html += `</div>
              <div class="order-totals" style="margin-top:12px;">
                <table class="totals-table">
                  <tr><td>Subtotal:</td><td>${data.totals ? data.totals.subtotal : ''}</td></tr>
                  <tr><td>Shipping:</td><td>${data.totals ? data.totals.shipping_total : ''}</td></tr>
                  <tr><td><strong>Total:</strong></td><td><strong>${data.totals ? data.totals.total : ''}</strong></td></tr>
                  <tr><td>Payment method:</td><td>${data.payment_method || ''}</td></tr>
                </table>
              </div>
              <div class="addr-section" style="display:flex;gap:20px;margin-top:20px;">
                ${renderAddressBox('Billing address', data.billing)}
                ${renderAddressBox('Shipping address', data.shipping)}
              </div>
              <div style="margin-top:10px;font-size:0.95em;color:#666">Store: ${outcome.success.endpoint}</div>
            </div>`;
                resultDiv.innerHTML = html;
                return;
            }

            // nothing found — show helpful message
            const tried = outcome.tried.map(t => `<li>${t}</li>`).join('');
            let helper = `<div class="error"><strong>Order not found</strong> — we checked: <ul style="margin:8px 0 8px 20px">${tried}</ul>`;
            if (outcome.lastError) {
                helper += `<div style="margin-top:6px;color:#b33">Last response from ${outcome.lastError.endpoint}: ${outcome.lastError.message}</div>`;
            } else {
                helper += `<div style="margin-top:6px;color:#b33">No response from servers.</div>`;
            }
            helper += `</div>`;
            resultDiv.innerHTML = helper;
        });







        // Format date string like "2025-10-27T18:29:32+00:00" to "27 Oct 2025"
        function formatDate(dateString) {
            if (!dateString) return '—';
            try {
                const date = new Date(dateString);
                // Format using Intl.DateTimeFormat for localization and short month names
                const formatted = new Intl.DateTimeFormat('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                }).format(date);
                return formatted; // e.g., "27 Oct 2025"
            } catch (e) {
                console.warn('Date format error:', e);
                return dateString; // fallback
            }
        }
    </script>









</body>

</html>